<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReelIndia - Feed</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { margin:0; background:#000; color:#fff; font-family:Arial; }
    .reel { height:100vh; position:relative; }
    video { width:100%; height:100%; object-fit:cover; }
    .overlay { position:absolute; bottom:80px; left:10px; }
    .overlay img { width:40px; height:40px; border-radius:50%; cursor:pointer; }
    .overlay h4 { margin:5px 0; cursor:pointer; }
    .follow-btn {
      background:#ff0050; border:none; padding:5px 10px; 
      border-radius:5px; color:white; cursor:pointer; margin-top:5px;
    }
    .actions { position:absolute; right:10px; bottom:120px; display:flex; flex-direction:column; gap:20px; align-items:center; }
    .actions i { font-size:24px; cursor:pointer; }
    .actions span { font-size:14px; margin-top:5px; }
    .bottom-nav { position:fixed; bottom:0; width:100%; background:#000; display:flex; justify-content:space-around; padding:10px 0; border-top:1px solid #333; }
    .bottom-nav i { font-size:22px; cursor:pointer; color:#fff; }
    .upload-btn { background:#ff0050; padding:10px 14px; border-radius:10px; margin-top:-15px; }
  </style>
</head>
<body>

  <!-- Reel Feed -->
  <div id="reel-feed"></div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <i class="fa-solid fa-house" onclick="goTo('/public/pages/index.html')"></i>
    <i class="fa-solid fa-chart-line" onclick="goTo('/public/pages/analytics.html')"></i>
    <div class="upload-btn" onclick="goTo('/public/pages/upload.html')">
      <i class="fa-solid fa-plus"></i>
    </div>
    <i class="fa-solid fa-inbox" onclick="goTo('/public/pages/chat.html')"></i>
    <i class="fa-solid fa-user" onclick="goTo('/public/pages/profile.html?user=self')"></i>
  </div>

  <script>
    const token = localStorage.getItem("token");
    const myEmail = localStorage.getItem("loggedInUser");

    if (!token) {
      document.body.innerHTML = "<h2>Please login again!</h2>";
    } else {
      loadReels();
    }

    async function loadReels() {
      try {
        const res = await fetch("/api/all-reels", {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await res.json();
        const feed = document.getElementById("reel-feed");
        feed.innerHTML = "";

        data.forEach((post, index) => {
          feed.innerHTML += `
            <div class="reel">
              <video id="video-${index}" src="${post.file}" autoplay loop muted></video>
              <div class="overlay">
                <img src="${post.profilePic}" onclick="openProfile('${post.email}')">
                <h4 onclick="openProfile('${post.email}')">@${post.name}</h4>
                ${post.email !== myEmail 
                  ? `<button class="follow-btn" onclick="toggleFollow('${post.email}', this)">
                       Follow
                     </button>` 
                  : ""}
                <p>${post.title}</p>
              </div>
              <div class="actions">
                <i class="fa-solid fa-heart" onclick="likeReel('${post.file}', this)"></i>
                <span>${post.likes}</span>
                <i class="fa-solid fa-eye"></i>
                <span>${post.views}</span>
                <i class="fa-solid fa-share"></i>
              </div>
            </div>
          `;

          setTimeout(() => {
            const video = document.getElementById(`video-${index}`);
            if (video) {
              video.addEventListener("play", () => addView(post.file, index), { once: true });
            }
          }, 100);
        });
      } catch (err) {
        console.error(err);
      }
    }

    async function likeReel(file, el) {
      const res = await fetch("/api/like-reel", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
        body: JSON.stringify({ file })
      });
      const data = await res.json();
      if (data.success) {
        el.nextElementSibling.textContent = data.likes;
        el.style.color = "red";
      }
    }

    async function addView(file, index) {
      const res = await fetch("/api/view-reel", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
        body: JSON.stringify({ file })
      });
      const data = await res.json();
      if (data.success) {
        const spans = document.querySelectorAll(".actions span");
        spans[index*2 + 1].textContent = data.views;
      }
    }

    async function toggleFollow(target, btn) {
      const res = await fetch("/api/follow", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
        body: JSON.stringify({ target })
      });
      const data = await res.json();
      if (data.success) {
        btn.innerText = data.action === "follow" ? "Unfollow" : "Follow";
      }
    }

    function goTo(page){ window.location.href = page; }
    function openProfile(user){ window.location.href = "/public/pages/profile.html?user="+user; }
  </script>
</body>
</html>
